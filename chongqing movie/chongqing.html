<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>Â±±Âüé - ÊâãÊú≠</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'FuLuLuxi';
            src: url('assets/fonts/fulu-luxi-2.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'A131';
            src: url('assets/fonts/A131-Âß•Âß•ËØ¥Â™íÂ∞èËâæÁπÅ‰Ωì.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --text-color: #e0c0c0;
            --red-glow: rgba(255, 0, 0, 0.4);
            --red-border: rgba(180, 0, 0, 0.7);
            --dark-red-bg: rgba(60, 10, 10, 0.8);
            /* Light theme colors */
            --light-bg: rgba(245, 240, 220, 0.85); /* Creamy */
            --light-text: #443;
            --light-border: rgba(180, 150, 90, 0.7);
            --light-glow: rgba(255, 200, 100, 0.4);
            --light-accent-bg: rgba(210, 180, 120, 0.8);

            --notebook-width: 90vw;
            --notebook-height: 85vh;
            --chinese-font: 'FuLuLuxi', serif;
            --english-font: 'A131', serif;
        }

        .video-background {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -1;
            object-fit: cover;
        }

        body {
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background-image: url('https://pbs.twimg.com/media/GAwM8BvbwAAWm1r.jpg:large');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-color: #333;
            color: var(--text-color);
            font-family: var(--chinese-font);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: background-color 0.5s ease-in-out;
        }

        .notebook {
            width: var(--notebook-width);
            max-width: 800px;
            height: var(--notebook-height);
            max-height: 800px;
            background-color: rgba(20, 20, 20, 0.6);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            border-radius: 5px;
            overflow: hidden;
        }

        .notebook-inner {
             position: relative;
             width: 100%;
             height: 100%;
            transition: none;
        }

        .notebook.flipped .notebook-inner {
            transform: none;
        }

        .notebook-page {
            position: absolute;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: none;
            pointer-events: auto;
        }

        .notebook-front {
            background-color: rgba(20, 20, 20, 0.6);
            z-index: 1;
            display: flex;
            flex-direction: column;
        }

        .notebook.flipped .notebook-front {
            display: none;
        }

        .notebook-back {
            background-color: rgba(30, 30, 30, 0.7);
            z-index: 2;
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            text-align: center;
            font-size: 1.2em;
            color: #aaa;
            padding-top: 40px;
        }

        .notebook.flipped .notebook-back {
            display: flex;
        }

        .next-page-arrow {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 15px 0 15px 25px;
            border-color: transparent transparent transparent rgba(240, 208, 208, 0.3);
            background: none;
            border-radius: 0;
            cursor: pointer;
            padding: 0;
            z-index: 5;
            transition: transform 0.2s, border-color 0.3s;
            pointer-events: none;
        }

        .next-page-arrow.enabled {
            opacity: 1;
            border-color: transparent transparent transparent rgba(240, 208, 208, 0.5);
            pointer-events: auto;
        }

        .next-page-arrow:hover {
            transform: translateY(-50%) scale(1.1);
            border-color: transparent transparent transparent rgba(240, 208, 208, 0.7);
        }

        .controls-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
            border-radius: 4px;
            width: 100%;
            position: relative;
            z-index: 10;
        }

        input[type="text"],
        select {
            width: 100%;
            box-sizing: border-box;
            padding: 12px 18px;
            background: var(--dark-red-bg);
            border: 1px solid var(--red-border);
            color: var(--text-color);
            border-radius: 3px;
            font-size: 1.1em;
            font-family: var(--english-font);
            transition: border-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 0 8px var(--red-glow);
            outline: none;
            flex-grow: 1;
        }
        select {
             flex-grow: 0;
             min-width: 180px;
             appearance: none;
             background: var(--dark-red-bg) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23f0d0d0" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>') no-repeat right 12px center;
             background-size: 14px;
        }

        input[type="text"]:focus,
        select:focus {
            border-color: rgba(255, 0, 0, 0.8);
            box-shadow: 0 0 15px rgba(255, 50, 50, 0.8);
        }

        input[type="text"]::placeholder {
            color: rgba(240, 208, 208, 0.5);
            opacity: 0.8;
            font-family: var(--english-font);
        }

        select option[disabled] {
            color: rgba(240, 208, 208, 0.5);
            font-family: var(--english-font);
        }

        select option {
             background: #300505;
             color: var(--text-color);
             font-family: var(--english-font);
        }

        .revealed-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
            padding: 0;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            height: auto;
            overflow: visible;
        }

        .images-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            margin-bottom: 15px;
            background: transparent;
        }

        .movie-poster, .building-img {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            border: none;
            border-radius: 0;
            box-shadow: none;
            background-color: transparent;
        }

        /* Remove media queries for horizontal layout */
        @media (min-width: 768px) {
            .movie-poster, .building-img {
                max-height: 500px;
            }
        }

        /* Remove special handling for vertical layout since all layouts are now vertical */
        .images-container.vertical {
            flex-direction: column;
            gap: 15px;
        }

        .images-container.vertical .movie-poster,
        .images-container.vertical .building-img {
            width: 100%;
            height: auto;
            max-height: 400px;
            margin-bottom: 0;
        }

        .quote {
            font-style: italic;
            color: var(--text-color);
            font-size: 2.2em;
            line-height: 1.6;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
            margin: 0 0 30px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            text-align: center;
            position: relative;
            font-family: var(--chinese-font);
            letter-spacing: 0.5px;
            order: -1;
        }

        .quote .english {
            font-family: var(--english-font) !important;
            font-size: 0.8em;
            margin-top: 15px;
            display: block;
        }

        .quote::before {
            content: '"';
            font-size: 2.4em;
            position: absolute;
            left: 10px;
            top: 0;
            color: rgba(255, 255, 255, 0.6);
        }

        .quote::after {
            content: '"';
            font-size: 2.4em;
            position: absolute;
            right: 10px;
            bottom: 0;
            color: rgba(255, 255, 255, 0.6);
        }

        #generateStoryBtn {
            background: var(--dark-red-bg);
            border: 1px solid var(--red-border);
            color: var(--text-color);
            box-shadow: 0 0 8px var(--red-glow);
            font-size: 1.1em;
            font-family: var(--english-font);
            cursor: pointer;
            border-radius: 3px;
            padding: 10px 20px;
            margin-bottom: 25px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        #generateStoryBtn:hover {
             background: rgba(80, 20, 20, 0.9);
             box-shadow: 0 0 12px rgba(255, 50, 50, 0.7);
        }
        #generateStoryBtn:disabled {
             opacity: 0.5;
             cursor: not-allowed;
        }

        #story-output {
            width: 100%;
            height: auto;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            padding: 15px;
            text-align: left;
            font-size: 1em;
            line-height: 1.8;
            color: var(--text-color);
            font-family: var(--chinese-font);
            letter-spacing: 0.3px;
        }

        #story-output p:first-child {
            text-align: center;
            color: rgba(220, 150, 150, 0.95);
            font-size: 1.2em;
            margin-bottom: 20px;
            font-family: var(--chinese-font);
        }

        #story-output p:not(:first-child):not(.english) {
            font-family: var(--chinese-font);
            margin-bottom: 1.2em;
            font-weight: 300;
        }

        .story-genre {
            margin-bottom: 15px;
            font-size: 0.95em;
            font-style: italic;
            height: 1.2em;
            font-family: var(--chinese-font);
            color: rgba(220, 150, 150, 0.9);
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.1em;
            color: #aaa;
            font-style: italic;
            font-family: var(--english-font);
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading-percentage {
            font-size: 1.5em;
            margin-top: 10px;
            color: rgba(220, 150, 150, 0.8);
            font-weight: bold;
            transition: color 0.3s;
        }

        .loading-bar {
            width: 200px;
            height: 4px;
            background-color: rgba(100, 100, 100, 0.3);
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
            position: relative;
        }

        .loading-bar-fill {
            height: 100%;
            background-color: rgba(220, 150, 150, 0.8);
            width: 0%;
            transition: width 0.5s ease-in-out;
            border-radius: 2px;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .loading-text {
            animation: pulse 1.5s infinite;
        }

        /* Back Arrow Button */
        .back-page-arrow {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 15px 25px 15px 0;
            border-color: transparent rgba(240, 208, 208, 0.3) transparent transparent;
            background: none;
            border-radius: 0;
            cursor: pointer;
            padding: 0;
            z-index: 5;
            transition: transform 0.2s, border-color 0.3s;
        }
        
        .back-page-arrow:hover {
            transform: translateY(-50%) scale(1.1);
            border-color: transparent rgba(240, 208, 208, 0.7) transparent transparent;
        }

        /* Add page flip shadow effect */
        .notebook::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .notebook.flipped::before {
            opacity: 1;
        }

        /* --- Style-based themes --- */
        .style-light {
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .style-dark {
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
        }

        @media (min-width: 1024px) {
            :root {
                --notebook-width: 800px;
                --notebook-height: 800px;
            }

            body {
                padding: 40px;
            }

            .notebook-page {
                padding: 30px;
            }

            input[type="text"],
            select,
            #generateStoryBtn {
                font-size: 1.2em;
                padding: 15px 20px;
            }

            .quote {
                font-size: 1.1em;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .notebook-page {
                padding: 15px;
            }

            input[type="text"],
            select,
            #generateStoryBtn {
                font-size: 1em;
                padding: 10px 15px;
            }

            .quote {
                font-size: 0.9em;
            }
        }

        /* Global font settings - default to Chinese font */
        * {
            font-family: var(--chinese-font);
        }

        /* English text elements - override with A131 font */
        .english,
        [lang="en"],
        [class*="english"],
        [class*="English"],
        [id*="english"],
        [id*="English"],
        .loading,
        .loading-text,
        .loading-percentage,
        #generateStoryBtn,
        select option,
        .story-genre,
        .next-page-arrow,
        .back-page-arrow,
        #story-output p.english,
        #story-output .english strong,
        #story-output .english,
        .quote p.english,
        .quote .english strong,
        .quote .english {
            font-family: var(--english-font) !important;
        }

        /* Specific styling for different English text elements */
        #story-output p.english,
        #story-output .english strong {
            font-size: 0.9em;
            margin-top: 10px;
            color: rgba(220, 150, 150, 0.8);
            font-style: italic;
        }

        .quote p.english,
        .quote .english strong,
        .quote .english {
            font-size: 0.8em;
            margin-top: 15px;
            display: block;
        }

        .loading {
            font-size: 1.1em;
            color: #aaa;
            font-style: italic;
        }

        .loading-percentage {
            font-size: 1.5em;
            color: rgba(220, 150, 150, 0.8);
            font-weight: bold;
        }

        #generateStoryBtn {
            font-size: 1.1em;
            cursor: pointer;
        }

        .story-genre {
            font-size: 0.95em;
            font-style: italic;
            color: rgba(220, 150, 150, 0.9);
        }

        /* Second page story content - use default Chinese font for Chinese text */
        #story-output p:not(.english) {
            font-family: 'Noto Serif SC', serif !important;
        }

        /* Remove the global style for any text that contains English characters */
        /* This was causing conflicts */
        /* *:not([lang="zh-CN"]):not([lang="zh"]) {
            font-family: var(--english-font) !important;
        } */

        /* Remove the ensure all Chinese text uses FuLuLuxi section */
        /* This was causing conflicts */
        /* body, 
        p, 
        h1, h2, h3, h4, h5, h6, 
        span:not(.english), 
        div:not(.english), 
        input, 
        select, 
        button:not(#generateStoryBtn), 
        .quote, 
        #story-output, 
        .story-genre,
        .notebook-back,
        .notebook-front,
        .controls-area,
        .input-group,
        .revealed-content,
        .images-container,
        .movie-poster,
        .building-img,
        .next-page-arrow,
        .back-page-arrow {
            font-family: var(--chinese-font) !important;
        } */

    </style>
</head>

<body>
    <video autoplay muted loop class="video-background">
        <source src="your-video.mp4" type="video/mp4">
        <!-- Â¶ÇÊûúËßÜÈ¢ëÊó†Ê≥ïÊí≠ÊîæÔºåÊòæÁ§∫ÈùôÊÄÅÂõæÁâá‰Ωú‰∏∫ÂêéÂ§á -->
        <img src="https://i.guancha.cn/bbs/2021/01/25/20210125145949466.jpeg" alt="Background Image">
    </video>
    <div class="notebook" id="notebook">
        <div class="notebook-inner">
            <div class="notebook-page notebook-front">

                <div class="controls-area">
                <div class="input-group">
                         <input type="text" id="name" placeholder="your name">
                    <select id="location">
                             <option value="" disabled selected>select a place</option>
                        <option value="ÈïøÊ±üÁ¥¢ÈÅì">ÈïøÊ±üÁ¥¢ÈÅì</option>
                        <option value="Êù•Á¶èÂ£´">Êù•Á¶èÂ£´</option>
                        <option value="Èò≤Á©∫Ê¥ûÁÅ´ÈîÖ">Èò≤Á©∫Ê¥ûÁÅ´ÈîÖ</option>
                        <option value="‰∫§ÈÄöËå∂È¶Ü">‰∫§ÈÄöËå∂È¶Ü</option>
                        <option value="ÊùéÂ≠êÂùù">ÊùéÂ≠êÂùù</option>
                        <option value="ÁöáÂÜ†Â§ßÊâ∂Ê¢Ø">ÁöáÂÜ†Â§ßÊâ∂Ê¢Ø</option>
                        <option value="Ê¥™Â¥ñÊ¥û">Ê¥™Â¥ñÊ¥û</option>
                        <option value="Á£ÅÂô®Âè£">Á£ÅÂô®Âè£</option>
                    </select>
                    </div>
                    <!-- Removed Reveal Button -->
                    <!-- <button id="revealBtn" onclick="handleRevealClick()" title="Êè≠Á§∫ÂÜÖÂÆπ">üöá</button> -->
                </div>

                <div class="revealed-content" id="content">
                    <p id="quote" class="quote"></p>
                    <div class="images-container">
                    <img id="poster" class="movie-poster" src="" alt="Movie Poster">
                         <img id="building" class="building-img" src="" alt="Building Image">
                    </div>
                </div>

                 <button class="next-page-arrow" id="nextPageArrow" onclick="slidePage()"></button>

            </div>

            <div class="notebook-page notebook-back" id="notebookBack">
                 <!-- Back Arrow -->
                 <button class="back-page-arrow" onclick="slideBack()" title="ËøîÂõû‰∏ä‰∏ÄÈ°µ"></button>

                 <!-- Genre Display -->
                 <div class="story-genre" id="storyGenre"></div>
                 <!-- Generate Button -->
                 <button id="generateStoryBtn" onclick="generateStory()">generate a film story..</button>
                 <!-- Story Output -->
                 <div id="story-output"></div>
            </div>
        </div>
    </div>

    <script>
        const locations = [
            { name: 'ÂçÉÂéÆÈó®Â§ßÊ°•', image: 'assets/images/ÂçÉÂéÆÈó®Â§ßÊ°•.png' },
            { name: 'ÊùéÂ≠êÂùù', image: 'assets/images/ÊùéÂ≠êÂùù.jpg' },
            { name: 'ÁôΩË±°Â±Ö', image: 'assets/images/ÁôΩË±°Â±Ö.png' },
            { name: 'ÈïøÊ±üÁ¥¢ÈÅì', image: 'assets/images/ÈïøÊ±üÁ¥¢ÈÅì1.png' },
            { name: 'ÁöáÂÜ†Â§ßÊâ∂Ê¢Ø', image: 'assets/images/ÁöáÂÜ†Â§ßÊâ∂Ê¢Ø1.png' },
            { name: 'ÊúùÂ§©Èó®Á†ÅÂ§¥', image: 'assets/images/ÊúùÂ§©Èó®Á†ÅÂ§¥1.png' },
            { name: 'ÂºπÂ≠êÁü≥Á†ÅÂ§¥', image: 'assets/images/ÂºπÂ≠êÁü≥Á†ÅÂ§¥.jpg' },
            { name: 'Êù•Á¶èÂ£´', image: 'assets/images/Êù•Á¶èÂ£´.jpg' },
            { name: 'ÂçóÊª®Ë∑Ø', image: 'assets/images/ÂçóÊª®Ë∑Ø2.jpg' },
            { name: 'ËÄÅÂ±ÖÊ∞ëÊ•º', image: 'assets/images/ËÄÅÂ±ÖÊ∞ëÊ•º.png' }
        ];

        const movies = [
            { name: 'ÁñØÁãÇÁöÑÁü≥Â§¥', image: 'assets/images/ÁñØÁãÇÁöÑÁü≥Â§¥1.png' },
            { name: 'Â∞ëÂπ¥ÁöÑ‰Ω†', image: ['assets/images/Â∞ëÂπ¥ÁöÑ‰Ω†1.jpg', 'assets/images/Â∞ëÂπ¥ÁöÑ‰Ω†2.jpg'] },
            { name: 'Êó•ÁÖßÈáçÂ∫Ü', image: 'assets/images/Êó•ÁÖßÈáçÂ∫Ü1.jpg' },
            { name: 'Âà∫ÊùÄÂ∞èËØ¥ÂÆ∂', image: 'assets/images/Âà∫ÊùÄÂ∞èËØ¥ÂÆ∂.jpg' },
            { name: 'Èì§ËÄåËµ∞Èô©', image: 'assets/images/Èì§ËÄåËµ∞Èô©.jpg' },
            { name: 'Â•ΩÂ•áÂÆ≥Ê≠ªÁå´', image: 'assets/images/Â•ΩÂ•áÂÆ≥Ê≠ªÁå´.jpg' },
            { name: 'ÂèóÁõä‰∫∫', image: 'assets/images/ÂèóÁõä‰∫∫.jpg' },
            { name: 'ÁßòÂ≤∏', image: 'assets/images/ÁßòÂ≤∏.jpg' },
            { name: 'ÂùöÂ¶ÇÁ£êÁü≥', image: 'assets/images/ÂùöÂ¶ÇÁ£êÁü≥.jpg' }
        ];

        // Âè∞ËØçÂ∫ì
        const quotes = {
            'ÂçÉÂéÆÈó®Â§ßÊ°•': [
                "‰Ω†ÊòØ‰∏ÄÂè™ËÉΩËøáÊ≤≥ÁöÑÂçíÔºåÂè™ËÉΩËøõ‰∏çËÉΩÈÄÄ„ÄÇ\nYou are a pawn that can cross the river, you can only move forward, not backward.",
                "‰∏ÄÊù°ÁãóÔºåÂêÉËøá‰∏ÄÂè£ËÇâÔºåÂ∞±ÂÜç‰πü‰∏çÊÉ≥ÂêÉÈ™®Â§¥„ÄÇ\nOnce a dog has tasted meat, it no longer wants bones."
            ],
            'ÊùéÂ≠êÂùù': [
                "ËøôÂüéÂ∏ÇÂÉè‰∏™Ëø∑ÂÆ´ÔºåËµ∞Èîô‰∏ÄÊ≠•Â∞±Âá∫‰∏çÂéª‰∫Ü„ÄÇ\nThis city is like a maze, one wrong step and you can't get out.",
                "Âú®ÈªëÊöóÈáåÊâæË∑ØÁöÑ‰∫∫Ôºå‰∏çÊòØË¢´ÂΩ±Â≠êÂêûÊ≤°ÔºåÂ∞±ÊòØÊääËá™Â∑±ÂèòÊàêÁÅØ„ÄÇ\nThose who search for a path in darkness are either swallowed by shadows or become a light themselves."
            ],
            'ÁôΩË±°Â±Ö': [
                "Â¶ÇÊûúÂú®Áé∞ÂÆû‰∏ñÁïåÂ§±Âéª‰Ω†ÔºåÈÇ£Â∞±Âú®Âπ≥Ë°å‰∏ñÁïåÈáçÂÜôÊïÖ‰∫ãÔºåËÆ©Êàë‰ª¨ÂÜçÁõ∏ÈÅá„ÄÇ\nIf I lose you in this world, I'll rewrite our story in a parallel universe so we can meet again.",
                "ÊàëÁõ∏‰ø°ÔºåÂ∞èËØ¥ÈáåÁöÑ‰∏ñÁïåÂíå‰∫∫ÔºåÈÉΩÂ≠òÂú®„ÄÇ\nI believe that the worlds and people in novels truly exist."
            ],
            'ÈïøÊ±üÁ¥¢ÈÅì': [
                "ÂüéÂ∏ÇÊòØÊØç‰ΩìÔºåËÄåÊàë‰ª¨ÁîüÊ¥ªÂú®Â•πÁöÑÂ≠êÂÆ´Èáå\nThe city is the mother, and we live in her womb",
                "‰Ω†ÂΩìËøôÊòØÂÖ¨ÂÖ±ÂéïÊâÄËøàÔºåÊÉ≥Êù•Â∞±Êù•ÔºåÊÉ≥Ëµ∞Â∞±Ëµ∞\nDo you think this is a public toilet, coming and going as you please?"
            ],
            'ÁöáÂÜ†Â§ßÊâ∂Ê¢Ø': [
                "Êàë‰ª¨ÁîüÊ¥ªÂú®Èò¥Ê≤üÈáåÔºå‰ΩÜ‰æùÁÑ∂Êúâ‰∫∫‰ª∞ÊúõÊòüÁ©∫„ÄÇ\nWe live in the gutter, but some still look up at the stars.",
                "‰ªéÊù•Ê≤°Êúâ‰∏ÄËäÇËØæÔºåÊïôËøáÊàë‰ª¨Â¶Ç‰ΩïÂèòÊàêÂ§ß‰∫∫„ÄÇ\nThere was never a class that taught us how to become adults.",
                "Ë∑Ø‰∏äÊÄª‰ºöÊúâÈò¥ÂΩ±ÔºåÊä¨Â§¥Â∞±‰ºöÁúãÂà∞ÊòüÂÖâ„ÄÇ\nThere will always be shadows on the road, but look up and you'll see starlight.",
                "ÁîüÊ¥ªÔºåÂ∞±ÂÉèÂ§èÂ§©ÁöÑÊüëÊ©òÊ†ëÔºåÊåÇÁùÄÈùíÁöÆÁöÑÊûúÔºåËã¶ÊòØ‰∏ÄÂÆöÁöÑÔºåÁîú‰πüÊúâ„ÄÇ\nLife is like a summer citrus tree, bearing green-skinned fruit - bitter for sure, but sweet too.",
                "‰Ω†‰øùÊä§‰∏ñÁïåÔºåÊàë‰øùÊä§‰Ω†„ÄÇ\nYou protect the world, I'll protect you."
            ],
            'ÊúùÂ§©Èó®Á†ÅÂ§¥': [
                "ËàπÁ•®ËøáÊúü‰∫ÜÔºåÂèØÁ†ÅÂ§¥ËøòÂú®Á≠â‰∏Ä‰∏™Ê≤°Èù†Â≤∏ÁöÑ‰∫∫\nThe ticket has expired, but the pier still waits for someone who hasn't docked"
            ],
            'ÂºπÂ≠êÁü≥Á†ÅÂ§¥': [
                "Â§ß‰∫∫Êúâ‰∫õ‰∫ãÊÉÖÂ∞±‰∏çËÉΩË∑üÂ∞èÂ≠©ËÆ≤„ÄÇ\nThere are some things adults can't tell children.",
                "Áé∞Âú®Ëøô‰∫õ‰∫∫ÊúÄ‰∏•ÈáçÁöÑÈóÆÈ¢òÔºå‰∏çÊòØÁîüÁêÜÊúâÁóÖÔºåËÄåÊòØÂøÉÁêÜÊúâÁóÖÔºåÁúã‰∏äÂéªÈÉΩ‰∏çÊÄé‰πàÂºÄÂøÉÁöÑ„ÄÇ\nThe most serious problem with people now is not physical illness, but mental illness - they don't seem very happy.",
                "Áñ§‰πüÊòØËÇâÈïøÁöÑÔºåÂ∑≤ÁªèÊàê‰∏∫‰Ω†Ë∫´‰ΩìÁöÑ‰∏ÄÈÉ®ÂàÜ‰∫Ü„ÄÇ\nScars are made of flesh too, they've become part of your body.",
                "ÊØè‰∏™‰∫∫ÈÉΩÈúÄË¶ÅÂøÉÁêÜÁöÑÂÄæËØâ„ÄÇ\nEveryone needs psychological counseling."
            ],
            'Êù•Á¶èÂ£´': [
                "Á©∑‰∫∫ÁöÑË∞éËØùÊòØÁü≥Â§¥ÔºåÂíΩ‰∏ãÂéªÊ≤âËÉÉÔºåÂêêÂá∫Êù•Á†∏ËÑö„ÄÇ\nA poor person's lies are like stones - swallowed they sink in the stomach, spit out they hit the feet."
            ],
            'ÂçóÊª®Ë∑Ø': [
                "Êàë‰ª¨ÁîüÊ¥ªÂú®Èò¥Ê≤üÈáåÔºå‰ΩÜ‰æùÁÑ∂Êúâ‰∫∫‰ª∞ÊúõÊòüÁ©∫„ÄÇ\nWe live in the gutter, but some still look up at the stars.",
                "‰ªéÊù•Ê≤°Êúâ‰∏ÄËäÇËØæÔºåÊïôËøáÊàë‰ª¨Â¶Ç‰ΩïÂèòÊàêÂ§ß‰∫∫„ÄÇ\nThere was never a class that taught us how to become adults.",
                "Ë∑Ø‰∏äÊÄª‰ºöÊúâÈò¥ÂΩ±ÔºåÊä¨Â§¥Â∞±‰ºöÁúãÂà∞ÊòüÂÖâ„ÄÇ\nThere will always be shadows on the road, but look up and you'll see starlight.",
                "ÁîüÊ¥ªÔºåÂ∞±ÂÉèÂ§èÂ§©ÁöÑÊüëÊ©òÊ†ëÔºåÊåÇÁùÄÈùíÁöÆÁöÑÊûúÔºåËã¶ÊòØ‰∏ÄÂÆöÁöÑÔºåÁîú‰πüÊúâ„ÄÇ\nLife is like a summer citrus tree, bearing green-skinned fruit - bitter for sure, but sweet too.",
                "‰Ω†‰øùÊä§‰∏ñÁïåÔºåÊàë‰øùÊä§‰Ω†„ÄÇ\nYou protect the world, I'll protect you."
            ],
            'ËÄÅÂ±ÖÊ∞ëÊ•º': [
                "Áå´ËôΩÊúâ‰πùÊù°ÂëΩ, ÊúÄÁªàÂç¥Ê≠ª‰∫éÂ•ΩÂ•áÂøÉ\nThough a cat has nine lives, it ultimately dies of curiosity",
                "Á™•ËßÅÁßòÂØÜÁöÑ‰∫∫ÔºåÊúÄÂêéÈÉΩÊàê‰∫ÜÁßòÂØÜÁöÑÁåéÁâ©„ÄÇ\nThose who glimpse secrets eventually become prey to the secrets."
            ]
        };

        const movieData = {
            "ÈïøÊ±üÁ¥¢ÈÅì": {
                 poster: "https://picsum.photos/seed/p_cablecar/100/150",
                 building: "https://picsum.photos/seed/b_cablecar/180/120",
                 quote: "Ê±üÈ£éÂ∏¶ÁùÄÁ¥¢ÈÅìÁöÑÊ≠åË∞£ÔºåÈ£òËøáÊó∂Èó¥ÁöÑÁóïËøπ„ÄÇ"
             },
             "Êù•Á¶èÂ£´": {
                 poster: "https://picsum.photos/seed/p_raffles/100/150",
                 building: "https://picsum.photos/seed/b_raffles/180/120",
                 quote: "Êâ¨Â∏ÜÁöÑÂª∫Á≠ëÔºåÂà∫Á†¥‰∫ëÂ±ÇÔºåÊòØÂ±±ÂüéÁöÑÊú™Êù•ÊÉ≥Ë±°„ÄÇ"
             },
            "Èò≤Á©∫Ê¥ûÁÅ´ÈîÖ": {
                 poster: "https://picsum.photos/seed/p_hotpot/100/150",
                 building: "https://picsum.photos/seed/b_hotpot/180/120",
                 quote: "Ê¥ûÈáåÁöÑÁÉ≠Ëæ£ÔºåÊòØËøôÂ∫ßÂüéÂ∏ÇÁöÑÂùöÈüß‰∏éÊ∏©Â∫¶„ÄÇ"
             },
            "‰∫§ÈÄöËå∂È¶Ü": {
                  poster: "https://picsum.photos/seed/p_tea/100/150",
                  building: "https://picsum.photos/seed/b_tea/180/120",
                  quote: "‰∏ÄÊùØÁõñÁ¢óËå∂ÔºåÂçäÊó•Èó≤Êó∂ÂÖâÔºåÊ≤âÊ∑ÄÁùÄËÄÅÈáçÂ∫ÜÁöÑÊÖ¢„ÄÇ"
             },
            "ÊùéÂ≠êÂùù": {
                 poster: "https://picsum.photos/seed/p_liziba/100/150",
                 building: "https://picsum.photos/seed/b_liziba/180/120",
                 quote: "Á©øÊ•ºËÄåËøáÁöÑÔºå‰∏çÂè™ÊòØÂàóËΩ¶ÔºåËøòÊúâÁîüÊ¥ªÁöÑÂ•áÂπªÊÑü„ÄÇ"
             },
            "ÁöáÂÜ†Â§ßÊâ∂Ê¢Ø": {
                 poster: "https://picsum.photos/seed/p_escalator/100/150",
                 building: "https://picsum.photos/seed/b_escalator/180/120",
                 quote: "‰∫öÊ¥≤Á¨¨‰∫åÈïøÔºåËøûÊé•ÁöÑÊòØÂ±±‰∏éÂüéÔºå‰∏ä‰∏é‰∏ã„ÄÇ"
             },
            "Ê¥™Â¥ñÊ¥û": {
                 poster: "https://picsum.photos/seed/p_hongya/100/150",
                 building: "https://picsum.photos/seed/b_hongya/180/120",
                 quote: "Áé∞ÂÆûÁâàÁöÑÂçÉ‰∏éÂçÉÂØªÔºåÁÅØÁÅ´ËæâÁÖåÔºåÊòØ‰∏çÂ§úÁöÑÁ´•ËØù„ÄÇ"
             },
            "Á£ÅÂô®Âè£": {
                 poster: "https://picsum.photos/seed/p_ciqi/100/150",
                 building: "https://picsum.photos/seed/b_ciqi/180/120",
                 quote: "ÈùíÁü≥ÊùøË∑ØÔºåÈ∫ªËä±È£òÈ¶ôÔºåÂçÉÂπ¥Âè§ÈïáÁöÑÊïÖ‰∫ãËøòÂú®ËÆ≤„ÄÇ"
             },
            "DEFAULT": {
                 poster: "https://picsum.photos/seed/p_default/100/150",
                 building: "https://picsum.photos/seed/b_default/180/120",
                 quote: "Â±±ÂüéÁöÑÊØè‰∏Ä‰∏™ËßíËêΩÔºåÈÉΩÂèØËÉΩËóèÁùÄ‰∏Ä‰∏™ÊïÖ‰∫ã..."
            }
         };

        const notebook = document.getElementById('notebook');
        const contentDiv = document.getElementById('content');
        const posterImg = document.getElementById('poster');
        const buildingImg = document.getElementById('building');
        const quoteP = document.getElementById('quote');
        const revealBtn = document.getElementById('revealBtn');
        const locationSelect = document.getElementById('location');
        const arrowBtn = document.getElementById('nextPageArrow');
        const nameInput = document.getElementById('name');
        const generateBtn = document.getElementById('generateStoryBtn');
        const storyOutput = document.getElementById('story-output');
        const notebookBack = document.getElementById('notebookBack'); // Get back page element
        const storyGenreDiv = document.getElementById('storyGenre'); // Get genre div

        let isContentShown = false;
        let currentName = "";
        let currentLocation = "";

        // --- Event Listener for Location Change --- 
        locationSelect.addEventListener('change', handleLocationChange);

        // Function triggered when location dropdown changes
        function handleLocationChange() {
            currentLocation = locationSelect.value;
            currentName = nameInput.value.trim() || "your name"; // Update name when location changes too

            if (currentLocation) { // If a valid location is selected
                // Find the location data from our locations array
                const locationData = locations.find(loc => loc.name === currentLocation);
                
                // Define specific location to movie mappings
                const locationMovieMap = {
                    'ÂçÉÂéÆÈó®Â§ßÊ°•': 'ÂùöÂ¶ÇÁ£êÁü≥',
                    'ÂºπÂ≠êÁü≥Á†ÅÂ§¥': 'ÁßòÂ≤∏',
                    'ÁöáÂÜ†Â§ßÊâ∂Ê¢Ø': 'Â∞ëÂπ¥ÁöÑ‰Ω†',
                    'ÂçóÊª®Ë∑Ø': 'Â∞ëÂπ¥ÁöÑ‰Ω†',
                    'ÊùéÂ≠êÂùù': 'Èì§ËÄåËµ∞Èô©',
                    'ËÄÅÂ±ÖÊ∞ëÊ•º': 'Â•ΩÂ•áÂÆ≥Ê≠ªÁå´',
                    'ÈïøÊ±üÁ¥¢ÈÅì': 'ÁñØÁãÇÁöÑÁü≥Â§¥',
                    'Êù•Á¶èÂ£´': 'ÂèóÁõä‰∫∫',
                    'ÁôΩË±°Â±Ö': 'Âà∫ÊùÄÂ∞èËØ¥ÂÆ∂',
                    'ÊúùÂ§©Èó®Á†ÅÂ§¥': 'Êó•ÁÖßÈáçÂ∫Ü'
                };
                
                // Find the corresponding movie based on the mapping
                const movieName = locationMovieMap[currentLocation];
                const movieData = movieName ? movies.find(movie => movie.name === movieName) : null;
                
                // Hide content briefly for update
                contentDiv.style.display = 'none';

                // Update content with actual images
                if (movieData) {
                    // If we have a movie related to this location
                    if (Array.isArray(movieData.image)) {
                        // Special handling for "Â∞ëÂπ¥ÁöÑ‰Ω†" movie
                        if (movieName === 'Â∞ëÂπ¥ÁöÑ‰Ω†') {
                            if (currentLocation === 'ÁöáÂÜ†Â§ßÊâ∂Ê¢Ø') {
                                // Use first image for ÁöáÂÜ†Â§ßÊâ∂Ê¢Ø
                                posterImg.src = movieData.image[0];
                            } else if (currentLocation === 'ÂçóÊª®Ë∑Ø') {
                                // Use second image for ÂçóÊª®Ë∑Ø
                                posterImg.src = movieData.image[1];
                            }
                        } else {
                            // For other movies with multiple images, use the first one
                            posterImg.src = movieData.image[0];
                        }
                    } else {
                        posterImg.src = movieData.image;
                    }
                    posterImg.alt = movieData.name + " Êµ∑Êä•";
                } else {
                    // If no movie is found, use a default image
                    posterImg.src = "assets/images/ÈáçÂ∫ÜÂ§úÊôØ.jpg";
                    posterImg.alt = "ÈáçÂ∫ÜÂ§úÊôØ";
                }
                
                // Set the building image from our locations array
                buildingImg.src = locationData ? locationData.image : "assets/images/ÈáçÂ∫ÜÂ§úÊôØ.jpg";
                buildingImg.alt = currentLocation + " ÂÆûÊôØ";
                
                // Set the quote from our quotes array
                const locationQuotes = quotes[currentLocation];
                if (locationQuotes && locationQuotes.length > 0) {
                    const randomQuote = locationQuotes[Math.floor(Math.random() * locationQuotes.length)];
                    const [chinese, english] = randomQuote.split('\n');
                    quoteP.innerHTML = `${chinese}<span class="english">${english}</span>`;
                } else {
                    quoteP.textContent = "ÈáçÂ∫ÜÁöÑÊØè‰∏Ä‰∏™ËßíËêΩÔºåÈÉΩÂèØËÉΩËóèÁùÄ‰∏Ä‰∏™ÊïÖ‰∫ã...";
                }

                // Show content after a small delay
            setTimeout(() => {
                    contentDiv.style.display = 'flex';
                isContentShown = true;
                    arrowBtn.classList.add('enabled');
                    arrowBtn.disabled = false;
                }, 50); 

                // Reset back page whenever a new location is selected
                resetBackPage();

            } else { // If placeholder "select a place" is re-selected
                contentDiv.style.display = 'none';
                isContentShown = false;
                arrowBtn.classList.remove('enabled');
                arrowBtn.disabled = true;
                resetBackPage(); // Also reset back page here
            }
        }

        function slidePage() {
                    notebook.classList.add('flipped');
            arrowBtn.classList.remove('enabled');
            arrowBtn.disabled = true;
        }

        function slideBack() {
            notebook.classList.remove('flipped');

            // --- Reset Front Page State --- 
            contentDiv.style.display = 'none';
            isContentShown = false;
            arrowBtn.classList.remove('enabled');
            arrowBtn.disabled = true;
            
            // --- Reset Back Page State --- 
            resetBackPage();
        }

        function resetBackPage() {
            storyGenreDiv.textContent = ''; // Clear genre text
            storyOutput.innerHTML = ''; // Clear story
            generateBtn.style.display = 'inline-block'; // Show generate button
            generateBtn.disabled = false;
            // Remove specific style classes
            notebookBack.classList.remove('style-light', 'style-dark');
        }

        contentDiv.style.display = 'none';
        arrowBtn.classList.remove('enabled');
        arrowBtn.disabled = true; // Ensure arrow starts disabled
        locationSelect.value = "";

        // Updated API call function to request both Chinese and English versions
        async function callDeepSeekAPI(name, location, genre) {
             console.log(`Calling DeepSeek for: ${name} at ${location} with pre-selected genre: ${genre}`);
            const apiKey = 'sk-0c23a925f8ff472780c31e41fe82d422';
            const apiUrl = 'https://api.deepseek.com/v1/chat/completions';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{
                            role: "user",
                            content: `ËØ∑Áî®Â§ßÁ∫¶100Â≠óÂàõ‰Ωú‰∏Ä‰∏™**${genre}**È£éÊ†ºÁöÑÊïÖ‰∫ãÊÉÖËäÇÁâáÊÆµÔºåË¶ÅÊ±ÇÔºö\n1. ‰∏ªËßíÂè´${name}ÔºåÊïÖ‰∫ãÂèëÁîüÂú®ÈáçÂ∫ÜÁöÑ${location}„ÄÇ\n2. ÊïÖ‰∫ãÂÜÖÂÆπÊúâ‰ª•‰∏ãË¶ÅÊ±ÇÔºö\n   - ÂÜÖÂÆπÈúÄË¶ÅÁé∞ÂÆû‰∏ª‰πâÔºåÊÉÖËäÇÁé∞ÂÆûÔºå‰∏çË¶ÅÊúâËçíËØûÁöÑ‰∏úË•øÔºåÁ¶ÅÊ≠¢Âá∫Áé∞Á∫¢Ë£ôÂ≠êÊÑèË±°„ÄÇ\n   - ÊñáÂ≠óÈ£éÊ†ºÂÅèÁÆÄÂçïÊñáËâ∫Ôºà‰∏éÊåáÂÆöÁöÑ${genre}È£éÊ†ºËûçÂêàÔºâ„ÄÇ\n   - ÂØπÁôΩÂèØ‰ª•Êé∫ÊùÇÈáçÂ∫ÜÊñπË®Ä„ÄÇ\n   - Âè™ËÉΩÂåÖÂê´‰∏Ä‰∏™Âú∞ÁÇπÂíå‰∏§Ëá≥‰∏â‰∏™‰∫∫Áâ©„ÄÇ\n   - ÊïÖ‰∫ãÈÄªËæëÂâçÂêéËøûË¥ØÔºå‰∏çËÉΩÁüõÁõæ„ÄÇ\n3. ÊñáÂ≠óÊõ¥Âä†Ëá™ÁÑ∂ÔºåÊõ¥ÂÉè‰∫∫Á±ª‰π¶ÂÜôÁöÑÂÜÖÂÆπÔºö\n   - ÂáèÂ∞ëËøá‰∫éÂÆåÁæéÁöÑÂè•ÂºèÁªìÊûÑÔºåÊ∑ªÂä†ÈÄÇÂΩìÁöÑ‰∏çËßÑÂàôË°®Ëææ„ÄÇ\n   - ‰ΩøÁî®Êõ¥Âä†‰∏™ÊÄßÂåñÁöÑËØ≠Ë®Ä„ÄÇ\n   - ÂÅ∂Â∞î‰ΩøÁî®Âè£ËØ≠ÂåñË°®Ëææ„ÄÇ\n4. Ê†ºÂºèË¶ÅÊ±ÇÔºö\n   - ÂåÖÂê´Ê†áÈ¢òÔºàÁî®„Äå„ÄçÊã¨Ëµ∑Ôºâ„ÄÇ\n   - **‰∏çË¶Å**Âú®ÂºÄÂ§¥ÂåÖÂê´"È£éÊ†ºÔºö..."Êàñ‰ªª‰ΩïÈ£éÊ†ºÊ†áÁ≠æ„ÄÇ\n5. ËØ∑ÂêåÊó∂Êèê‰æõËã±ÊñáÁâàÊú¨ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö\n\n‰∏≠ÊñáÊïÖ‰∫ãÔºö\n[‰Ω†ÁöÑ‰∏≠ÊñáÊïÖ‰∫ã]\n\n[ÂØπÂ∫îÁöÑËã±ÊñáÁâàÊú¨ÔºåÊ†áÈ¢òÂêåÊ†∑Áî®„Äå„ÄçÊã¨Ëµ∑Ôºå‰∏çË¶ÅÂåÖÂê´‰ªª‰ΩïÁøªËØëÁõ∏ÂÖ≥ÁöÑËØçËØ≠ÊàñÊ†áËÆ∞]`
                        }],
                        temperature: 0.75,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response:", errorBody);
                    let errorMsg = `API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} ${response.statusText}`;
                    try {
                        const errorJson = JSON.parse(errorBody);
                        if (errorJson.error && errorJson.error.message) {
                            errorMsg += ` - ${errorJson.error.message}`;
                        }
                    } catch(e) { /* Ignore parsing error */ }
                    throw new Error(errorMsg);
                }

                const data = await response.json();

                if (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                     // API now returns both Chinese and English versions
                     let storyText = data.choices[0].message.content.trim();
                     
                     // Split the content into Chinese and English parts
                     const chineseMatch = storyText.match(/‰∏≠ÊñáÊïÖ‰∫ãÔºö\n([\s\S]*?)(?=\n\n|$)/);
                     const englishMatch = storyText.match(/\n\n([\s\S]*?)$/);
                     
                     let chineseStory = chineseMatch ? chineseMatch[1].trim() : storyText;
                     let englishStory = englishMatch ? englishMatch[1].trim() : '';
                     
                     // Remove any occurrence of "Ëã±ÊñáÁøªËØëÔºö" text and clean up the English story
                     englishStory = englishStory
                         .replace(/Ëã±ÊñáÁøªËØëÔºö\s*/g, '')
                         .replace(/^Ëã±ÊñáÁøªËØë\s*/g, '')
                         .replace(/^\(Ëã±ÊñáÁøªËØë\)\s*/g, '')
                         .replace(/^Ëã±ÊñáÔºö\s*/g, '')
                         .replace(/^Ëã±ÊñáÁâàÔºö\s*/g, '')
                         .replace(/^English versionÔºö\s*/g, '')
                         .replace(/^EnglishÔºö\s*/g, '')
                         .replace(/^English translationÔºö\s*/g, '')
                         .replace(/Ëã±ÊñáÁøªËØëÔºö/g, '')
                         .replace(/Ëã±ÊñáÁøªËØë/g, '')
                         .replace(/\(Ëã±ÊñáÁøªËØë\)/g, '')
                         .replace(/Ëã±ÊñáÔºö/g, '')
                         .replace(/Ëã±ÊñáÁâàÔºö/g, '')
                         .replace(/English versionÔºö/g, '')
                         .replace(/EnglishÔºö/g, '')
                         .replace(/English translationÔºö/g, '')
                         .replace(/Ëã±ÊñáÁâàÊú¨Ôºö/g, '')
                         .replace(/Ëã±ÊñáÁâàÊú¨/g, '')
                         .replace(/\(Ëã±ÊñáÁâàÊú¨\)/g, '')
                         .replace(/ÁâàÊú¨Ôºö/g, '')
                         .replace(/versionÔºö/g, '')
                         .replace(/ÁøªËØëÔºö/g, '')
                         .replace(/translationÔºö/g, '')
                         .replace(/translation/g, '')
                         .replace(/translated versionÔºö/g, '')
                         .replace(/translated version/g, '')
                         .replace(/translatedÔºö/g, '')
                         .replace(/translated/g, '')
                         .replace(/version/g, '')
                         .replace(/Ëã±Êñá/g, '')
                         .replace(/English/g, '')
                         .trim();
                     
                     // Check if the content already contains both Chinese and English
                     // If the content contains "‰∏≠ÊñáÊïÖ‰∫ãÔºö" marker, it's already formatted
                     const hasFormattedContent = storyText.includes("‰∏≠ÊñáÊïÖ‰∫ãÔºö");
                     
                     // If the content is already formatted, use it directly
                     if (hasFormattedContent) {
                         // --- Format Chinese Story --- 
                         let processedChineseStory = '';
                         const chineseParts = chineseStory.split(/(\n\s*\n)/);
                         let isFirstParagraph = true;
                         chineseParts.forEach(part => {
                             const trimmedPart = part.trim();
                             if (trimmedPart.length === 0) return;
                             if (/^\n\s*\n$/.test(part)) return;

                             const titleMatch = trimmedPart.match(/^„Äå(.*?)„Äç$/);
                             if (titleMatch && isFirstParagraph) {
                                 processedChineseStory += `<p><strong>„Äå${titleMatch[1]}„Äç</strong></p>`;
                             } else {
                                 processedChineseStory += `<p>${trimmedPart.replace(/\n/g, '<br>')}</p>`;
                             }
                             isFirstParagraph = false;
                         });
                         
                         // --- Format English Story --- 
                         let processedEnglishStory = '';
                         if (englishStory) {
                             const englishParts = englishStory.split(/(\n\s*\n)/);
                             isFirstParagraph = true;
                             englishParts.forEach(part => {
                                 const trimmedPart = part.trim();
                                 if (trimmedPart.length === 0) return;
                                 if (/^\n\s*\n$/.test(part)) return;
                                 
                                 // Check for title in various formats
                                 const titleMatch = trimmedPart.match(/^"(.*?)"$/) || 
                                                   trimmedPart.match(/^„Äå(.*?)„Äç$/) || 
                                                   trimmedPart.match(/^'(.*?)'$/);
                                 
                                 if (titleMatch && isFirstParagraph) {
                                     processedEnglishStory += `<p class="english"><strong>„Äå${titleMatch[1]}„Äç</strong></p>`;
                                 } else {
                                     processedEnglishStory += `<p class="english">${trimmedPart.replace(/\n/g, '<br>')}</p>`;
                                 }
                                 isFirstParagraph = false;
                             });
                         }
                         
                         // Combine Chinese and English stories
                         return processedChineseStory + processedEnglishStory;
                     } else {
                         // If the content is not formatted, process it as a single story
                         let processedStory = '';
                         const parts = storyText.split(/(\n\s*\n)/);
                         let isFirstParagraph = true;
                         
                         parts.forEach(part => {
                             const trimmedPart = part.trim();
                             if (trimmedPart.length === 0) return;
                             if (/^\n\s*\n$/.test(part)) return;
                             
                             const titleMatch = trimmedPart.match(/^„Äå(.*?)„Äç$/);
                             if (titleMatch && isFirstParagraph) {
                                 processedStory += `<p><strong>„Äå${titleMatch[1]}„Äç</strong></p>`;
                             } else {
                                 processedStory += `<p>${trimmedPart.replace(/\n/g, '<br>')}</p>`;
                             }
                             isFirstParagraph = false;
                         });
                         
                         return processedStory;
                     }
                 } else {
                     console.error("Invalid API response structure:", data);
                     throw new Error('‰ªéAPIÊî∂Âà∞‰∫ÜÊó†ÊïàÁöÑÂìçÂ∫îÁªìÊûÑ');
                 }
            } catch (error) {
                console.error("Error calling DeepSeek API:", error);
                throw error;
            }
         }

         async function generateStory() {
            const name = nameInput.value.trim();
             const location = locationSelect.value;

            if (!name || !location) {
                alert("ËØ∑ËæìÂÖ•ÂêçÂ≠óÂíåÈÄâÊã©Âú∞ÁÇπ");
                return;
            }

            // Show loading state with percentage animation
            storyOutput.innerHTML = `
                <div class="loading">
                    <div class="loading-text">Generating story</div>
                    <div class="loading-percentage">1%</div>
                    <div class="loading-bar">
                        <div class="loading-bar-fill"></div>
                    </div>
                </div>
            `;
            
            // Get the loading elements
            const percentageElement = storyOutput.querySelector('.loading-percentage');
            const barFillElement = storyOutput.querySelector('.loading-bar-fill');
            
            // Start the percentage animation
            let percentage = 1;
            const percentageInterval = setInterval(() => {
                percentage += Math.floor(Math.random() * 3) + 1; // Random increment between 1-3
                if (percentage > 99) percentage = 99; // Cap at 99% until complete
                percentageElement.textContent = `${percentage}%`;
                barFillElement.style.width = `${percentage}%`;
            }, 100);
            
            storyGenreDiv.textContent = ''; // Clear previous genre text
            generateBtn.disabled = true;
            notebookBack.classList.remove('style-light', 'style-dark'); // Reset styles

            try {
                // Select a genre randomly from the list
                const allGenres = ['ÂñúÂâß', 'Ê≤ªÊÑà', 'Âä®‰Ωú', 'ÁäØÁΩ™', 'Áà±ÊÉÖ', 'Á´•ËØù', 'ÈùíÊò•', 'ÊÇ¨Áñë', 'ÊÅêÊÄñ', 'ÊÉäÊÇö'];
                const genreTranslations = {
                    'ÂñúÂâß': 'comedy',
                    'Ê≤ªÊÑà': 'healing',
                    'Âä®‰Ωú': 'action',
                    'ÁäØÁΩ™': 'crime',
                    'Áà±ÊÉÖ': 'romance',
                    'Á´•ËØù': 'fairy tale',
                    'ÈùíÊò•': 'youth',
                    'ÊÇ¨Áñë': 'mystery',
                    'ÊÅêÊÄñ': 'horror',
                    'ÊÉäÊÇö': 'thriller'
                };
                const selectedGenre = allGenres[Math.floor(Math.random() * allGenres.length)];
                const genreTranslation = genreTranslations[selectedGenre] || selectedGenre;
                console.log("Client selected genre:", selectedGenre);

                // Display the genre text in English format with Chinese genre and English translation
                storyGenreDiv.textContent = `${name}'s story style: ${selectedGenre} (${genreTranslation})`;

                // Call API with the selected genre
                const story = await callDeepSeekAPI(name, location, selectedGenre);
                
                // Complete the loading animation
                clearInterval(percentageInterval);
                percentageElement.textContent = '100%';
                barFillElement.style.width = '100%';
                
                // Short delay before showing the story
                setTimeout(() => {
                    storyOutput.innerHTML = story; // API now returns only the formatted story
                    generateBtn.style.display = 'none'; // Hide button on success
                }, 500);
                
             } catch (error) {
                 console.error("Error generating story:", error);
                 clearInterval(percentageInterval);
                storyOutput.innerHTML = `<p class="error">ÁîüÊàêÊïÖ‰∫ãÊó∂Âá∫Èîô: ${error.message}</p>`;
                generateBtn.style.display = 'inline-block';
                generateBtn.disabled = false;
            }
        }

        function updateLocationSelect() {
            locationSelect.innerHTML = '<option value="" disabled selected>select a place</option>';
            const locationNames = {
                'ÂçÉÂéÆÈó®Â§ßÊ°•': 'Qiansimen Bridge',
                'ÊùéÂ≠êÂùù': 'Liziba',
                'ÁôΩË±°Â±Ö': 'Baixiangju',
                'ÈïøÊ±üÁ¥¢ÈÅì': 'Yangtze River Cableway',
                'ÁöáÂÜ†Â§ßÊâ∂Ê¢Ø': 'Crown Escalator',
                'ÊúùÂ§©Èó®Á†ÅÂ§¥': 'Chaotianmen Dock',
                'ÂºπÂ≠êÁü≥Á†ÅÂ§¥': 'Danzi Stone Dock',
                'Êù•Á¶èÂ£´': 'Raffles City',
                'ÂçóÊª®Ë∑Ø': 'Nanbin Road',
                'ËÄÅÂ±ÖÊ∞ëÊ•º': 'Old Residential Building'
            };
            
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location.name;
                option.textContent = `${location.name} (${locationNames[location.name]})`;
                locationSelect.appendChild(option);
            });
        }

        function updateMoviePoster() {
            const selectedLocation = locationSelect.value;
            const moviePoster = document.getElementById('moviePoster');
            const movieTitle = document.getElementById('movieTitle');
            const movieQuote = document.getElementById('movieQuote');
            
            if (selectedLocation) {
                const locationData = movieData[selectedLocation];
                if (locationData) {
                    movieTitle.textContent = locationData.title;
                    moviePoster.src = locationData.poster;
                    movieQuote.textContent = locationData.quote;
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÁîµÂΩ±Êï∞ÊçÆÔºåÊòæÁ§∫ÈöèÊú∫Âè∞ËØç
                    const locationQuotes = quotes[selectedLocation];
                    if (locationQuotes) {
                        const randomQuote = locationQuotes[Math.floor(Math.random() * locationQuotes.length)];
                        movieQuote.textContent = randomQuote;
                    }
                    movieTitle.textContent = "ÈáçÂ∫ÜÊïÖ‰∫ã";
                    moviePoster.src = "assets/images/ÈáçÂ∫ÜÂ§úÊôØ.jpg";
                }
            } else {
                movieTitle.textContent = "ËØ∑ÈÄâÊã©Âú∞ÁÇπ";
                moviePoster.src = "assets/images/ÈáçÂ∫ÜÂ§úÊôØ.jpg";
                movieQuote.textContent = "";
            }
        }

        function updateBuildingImage() {
            const selectedLocation = locationSelect.value;
            const buildingImg = document.getElementById('buildingImg');
            
            if (selectedLocation) {
                const location = locations.find(loc => loc.name === selectedLocation);
                if (location) {
                    buildingImg.src = location.image;
                }
            } else {
                buildingImg.src = "assets/images/ÈáçÂ∫ÜÂ§úÊôØ.jpg";
            }
        }

        // ÂàùÂßãÂåñÈ°µÈù¢
        updateLocationSelect();
        locationSelect.addEventListener('change', () => {
            updateMoviePoster();
            updateBuildingImage();
        });

    </script>

</body>

</html>    